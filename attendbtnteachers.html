<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Attendance Session | SmartAttend</title>

  <!-- fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- shared styles -->
  <link rel="stylesheet" href="samedesign.css" />
</head>
<body>

<div class="teacher-dashboard">

  <!-- TOP BAR (same as other pages) -->
  <header class="teacher-topbar">
    <div class="teacher-topbar-left">
      <div class="logo">
        <img src="Icons/Logo.png" alt="SmartAttend logo" />
        <span class="logo-text">SmartAttend</span>
      </div>
    </div>

    <div class="teacher-topbar-right">
      <div class="teacher-identity">
        <span class="teacher-identity-name">Name of Teacher</span>
        <span class="teacher-identity-role">(teacher)</span>
      </div>

      <button class="teacher-logout-btn">
        <img src="Icons/Logout Icon.png" alt="Logout" class="logout-icon" />
        <span class="teacher-logout-text">Logout</span>
      </button>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="create-class-main-attendance-main">

    <!-- back link -->
    <a href="teacher-class-created.html" class="create-class-back">
      ‚Üê Back to Dashboard
    </a>

    <!-- header -->
    <section class="attendance-header">
      <h1 class="attendance-title">SAD21</h1>
      <p class="attendance-subtitle">Attendance Session Management</p>
    </section>

    <!-- two cards -->
    <section class="attendance-grid">
      <article class="attendance-card attendance-card-primary">
  <div class="attendance-card-heading">
    <span class="attendance-icon">
      <img src="Icons/QRcode.png" alt="QR Code" />
    </span>
    <h2 class="attendance-card-title">QR Code</h2>
  </div>

  <p class="attendance-card-text">
    Students scan this code to request attendance
  </p>

  <!-- STATE 1: before starting -->
  <div class="qr-state qr-before">
    <button class="attendance-btn-primary" id="start-session-btn">
      Start Attendance Session
    </button>
  </div>

  <!-- STATE 2: session running -->
  <div class="qr-state qr-active">
    <div class="qr-code-large">
      <img src="Icons/QRcode.png" alt="QR Code" />
    </div>

    <div class="qr-footer">
      <div class="qr-timer">
  <div class="qr-timer-left">
    <span class="qr-timer-icon">
      <img src="Icons/Stopwatch.png" alt="Timer icon">
    </span>
    <span class="qr-timer-label">Time Remaining:</span>
  </div>

  <span class="qr-timer-value" id="qr-timer-value">15:00</span>
</div>

      <button class="qr-close-btn" id="close-session-btn">
        Close Session
      </button>
    </div>
  </div>
</article>


      <!-- RIGHT: PENDING REQUEST -->
      <article class="attendance-card attendance-card-muted">
        <div>
          <h2 class="attendance-card-title">Pending Request</h2>
          <p id="pending-count" class="attendance-card-meta">
  0 students waiting for approval
</p>
<p id="pending-helper" class="attendance-card-text muted">
  Start a session to see requests
</p>

        </div>
      </article>
    </section>

  </main>
</div>

</body>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const mainEl        = document.querySelector('.create-class-main-attendance-main');
    const startBtn      = document.getElementById('start-session-btn');
    const closeBtn      = document.getElementById('close-session-btn');
    const timerEl       = document.getElementById('qr-timer-value');
    const pendingCount  = document.getElementById('pending-count');
    const pendingHelper = document.getElementById('pending-helper');

    const SESSION_DURATION = 15 * 60; // 15 minutes in seconds
    let timerInterval = null;

    /* ---------------- localStorage helpers ---------------- */

    function setSessionActive(isActive) {
      if (isActive) {
        // mark active + store when it should end
        localStorage.setItem('hasActiveAttendanceSession', 'true');
        const endTime = Date.now() + SESSION_DURATION * 1000;
        localStorage.setItem('attendanceSessionEndTime', String(endTime));
      } else {
        localStorage.removeItem('hasActiveAttendanceSession');
        localStorage.removeItem('studentRequestedAttendance');
        localStorage.removeItem('attendanceSessionEndTime');
      }
    }

    function getRemainingSeconds() {
      const endRaw = localStorage.getItem('attendanceSessionEndTime');
      if (!endRaw) return 0;
      const endTime = Number(endRaw);
      if (Number.isNaN(endTime)) return 0;
      const diffMs = endTime - Date.now();
      return Math.max(0, Math.floor(diffMs / 1000));
    }

    function formatAndSetTimer(remainingSeconds) {
      const mins = String(Math.floor(remainingSeconds / 60)).padStart(2, '0');
      const secs = String(remainingSeconds % 60).padStart(2, '0');
      if (timerEl) {
        timerEl.textContent = `${mins}:${secs}`;
      }
    }

    function refreshPendingUI() {
      const hasActive  = localStorage.getItem('hasActiveAttendanceSession') === 'true';
      const hasRequest = localStorage.getItem('studentRequestedAttendance') === 'true';

      if (!pendingCount || !pendingHelper) return;

      if (!hasActive) {
        pendingCount.textContent  = '0 students waiting for approval';
        pendingHelper.textContent = 'Start a session to see requests';
        return;
      }

      if (hasRequest) {
        pendingCount.textContent  = '1 student waiting for approval';
        pendingHelper.textContent = 'A student has requested attendance.';
      } else {
        pendingCount.textContent  = '0 students waiting for approval';
        pendingHelper.textContent = 'Waiting for students to scan the QR code';
      }
    }

    /* ---------------- timer logic ---------------- */

    function startTimerLoop() {
      if (timerInterval) clearInterval(timerInterval);

      // initial display based on whatever is in localStorage
      const initialRemaining = getRemainingSeconds();
      if (initialRemaining <= 0) {
        formatAndSetTimer(0);
        handleCloseSession();
        return;
      }
      formatAndSetTimer(initialRemaining);

      timerInterval = setInterval(() => {
        const remaining = getRemainingSeconds();

        if (remaining <= 0) {
          clearInterval(timerInterval);
          timerInterval = null;
          handleCloseSession(); // auto-close when time runs out
          return;
        }

        formatAndSetTimer(remaining);
      }, 1000);
    }

    /* ---------------- UI handlers ---------------- */

    function handleStartSession() {
      if (!mainEl) return;
      mainEl.classList.add('session-on');
      setSessionActive(true);
      startTimerLoop();
      refreshPendingUI();
    }

    function handleCloseSession() {
      if (!mainEl) return;

      mainEl.classList.remove('session-on');

      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      if (timerEl) timerEl.textContent = '15:00';
      setSessionActive(false);
      refreshPendingUI();
    }

    /* ---------------- event wiring ---------------- */

    if (startBtn) {
      startBtn.addEventListener('click', handleStartSession);
    }

    if (closeBtn) {
      closeBtn.addEventListener('click', handleCloseSession);
    }

    // Restore state if session was already active (same browser)
    if (localStorage.getItem('hasActiveAttendanceSession') === 'true') {
      if (mainEl) {
        mainEl.classList.add('session-on');
      }

      const remaining = getRemainingSeconds();
      if (remaining > 0) {
        formatAndSetTimer(remaining);
        startTimerLoop();
      } else {
        // timer already expired while page was closed
        handleCloseSession();
      }
    } else if (timerEl) {
      // default display when no session
      timerEl.textContent = '15:00';
    }

    refreshPendingUI();

    // If the student tab writes to localStorage, update the pending card
    window.addEventListener('storage', (event) => {
      if (event.key === 'studentRequestedAttendance' ||
          event.key === 'hasActiveAttendanceSession') {
        refreshPendingUI();
      }
    });
  });



 
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.teacher-logout-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();          // stop any default link/button behavior
        window.location.href = 'index.html';  // redirect to your home page
      });
    });
  });


</script>


</html>
